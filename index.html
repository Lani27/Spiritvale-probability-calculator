<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SpiritVale Stat Roll Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .filter-select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url('data:image/svg+xml;charset=UTF-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="none" stroke="%239ca3af" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9l4 4 4-4"/></svg>');
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1em;
        }

        #animation-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 9999; /* Increased z-index */
        }

        .drop-animation {
            position: absolute;
            width: 48px; /* Adjust size as needed */
            height: 48px;
            background-size: contain;
            background-repeat: no-repeat;
            will-change: transform, opacity;
        }

        @keyframes item-drop {
            0% {
                opacity: 1;
                transform: translateY(0) scale(0.8);
            }
            100% {
                opacity: 0;
                transform: translateY(-150px) scale(1.2) rotate(360deg);
            }
        }

        @keyframes item-pickup {
            0% {
                opacity: 1;
                transform: translateY(0) scale(0.8);
            }
            50% {
                opacity: 1;
                transform: translateY(-100px) scale(1.5) rotate(180deg);
            }
            100% {
                opacity: 0;
                transform: translateY(200px) scale(0.5) rotate(360deg);
            }
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-300">

    <div id="animation-container"></div>
    <div id="sidebar"></div>

    <!-- Main Content -->
    <main id="main-content" class="p-4 md:p-8">
        <div class="max-w-4xl mx-auto">
            <div class="bg-gray-800/70 rounded-lg border border-gray-700/50 p-6 md:p-8 transition-all hover:border-indigo-500/50 hover:shadow-2xl hover:shadow-indigo-500/10">
                <header class="text-center mb-8">
                    <h1 class="text-3xl md:text-4xl font-bold text-white">Stat Roll Calculator</h1>
                    <p class="text-slate-400 mt-2">Select your equipment and desired stats to see the roll probability.</p>
                </header>

                <!-- Equipment & Stat Selection -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 items-end">
                    <div class="md:col-span-4">
                        <label for="equipmentType" class="block text-sm font-medium text-gray-400 mb-2">Equipment Piece</label>
                        <select id="equipmentType" class="filter-select w-full bg-gray-700 border border-gray-600 rounded-md py-2.5 px-3 text-white focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-colors">
                            <!-- Options populated by JS -->
                        </select>
                    </div>

                    <div>
                        <label for="stat1" class="block text-sm font-medium text-gray-400 mb-2">Stat 1</label>
                        <select id="stat1" class="filter-select w-full bg-gray-700 border border-gray-600 rounded-md py-2.5 px-3 text-white focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-colors">
                            <!-- Options populated by JS -->
                        </select>
                    </div>

                    <div>
                        <label for="stat2" class="block text-sm font-medium text-gray-400 mb-2">Stat 2</label>
                        <select id="stat2" class="filter-select w-full bg-gray-700 border border-gray-600 rounded-md py-2.5 px-3 text-white focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-colors">
                            <!-- Options populated by JS -->
                        </select>
                    </div>

                    <div>
                        <label for="stat3" class="block text-sm font-medium text-gray-400 mb-2">Stat 3</label>
                        <select id="stat3" class="filter-select w-full bg-gray-700 border border-gray-600 rounded-md py-2.5 px-3 text-white focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-colors">
                            <!-- Options populated by JS -->
                        </select>
                    </div>

                    <div class="md:col-span-1">
                        <button id="calculateBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2.5 px-4 rounded-md transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-800 focus:ring-indigo-500">
                            Calculate
                        </button>
                    </div>
                </div>

                <!-- Error Message -->
                <div id="error-message" class="hidden text-center bg-red-900/50 border border-red-700 text-red-300 px-4 py-3 rounded-lg mt-6">
                    <p id="error-text"></p>
                </div>
            </div>

            <!-- Results Section -->
            <div id="results" class="hidden mt-8">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Scenario 1: Any Roll -->
                    <div class="bg-gray-800/70 rounded-lg border border-gray-700/50 p-6 text-center transition-all hover:border-indigo-500/50 hover:shadow-xl hover:shadow-indigo-500/10">
                        <h3 class="text-md font-medium text-indigo-400 mb-2">Chance for Right Stats (Any Roll)</h3>
                        <p class="text-4xl font-bold text-white" id="any-roll-chance"></p>
                        <p class="text-slate-400 mt-1" id="any-roll-fraction"></p>
                        <p class="text-xs text-slate-500 mt-3 break-words" id="any-roll-breakdown"></p>
                    </div>

                    <!-- Scenario 2: Perfect Roll -->
                    <div class="bg-gray-800/70 rounded-lg border border-gray-700/50 p-6 text-center transition-all hover:border-indigo-500/50 hover:shadow-xl hover:shadow-indigo-500/10">
                        <h3 class="text-md font-medium text-indigo-400 mb-2">Chance for Perfect Roll (Max Values)</h3>
                        <p class="text-4xl font-bold text-white" id="perfect-roll-chance"></p>
                        <p class="text-slate-400 mt-1" id="perfect-roll-fraction"></p>
                        <p class="text-xs text-slate-500 mt-3 break-words" id="perfect-roll-breakdown"></p>
                    </div>
                </div>
            </div>

            <footer class="text-center mt-8">
                <p class="text-xs text-slate-500">Probabilities are based on the assumption of equal chances for each outcome within a stat group.</p>
            </footer>
        </div>

        <!-- "Try Your Luck?" Section -->
        <div class="max-w-4xl mx-auto mt-8">
            <div class="bg-gray-800/70 rounded-lg border border-gray-700/50 p-6 md:p-8 transition-all hover:border-purple-500/50 hover:shadow-2xl hover:shadow-purple-500/10">
                <header class="text-center mb-6">
                    <h2 class="text-2xl md:text-3xl font-bold text-white">Try Your Luck?</h2>
                    <p class="text-slate-400 mt-2">Simulate monster kills to see if you get your desired equipment.</p>
                </header>

                <div class="flex flex-col items-center">
                    <button id="luckToggleBtn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2.5 px-6 rounded-md transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-800 focus:ring-purple-500">
                        Try your luck?
                    </button>
                </div>

                <div id="luck-section" class="hidden mt-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-start">
                        <div class="md:col-span-2">
                            <label for="luck-equipment-search" class="block text-sm font-medium text-gray-400 mb-2">Search for an Equipment Piece</label>
                            <input type="text" id="luck-equipment-search" list="equipment-luck-list" class="w-full bg-gray-700 border border-gray-600 rounded-md py-2.5 px-3 text-white focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="Type to search for equipment...">
                            <datalist id="equipment-luck-list"></datalist>
                        </div>
                    </div>

                    <div id="luck-monster-list" class="hidden mt-4">
                        <!-- Monster radio buttons will be injected here -->
                    </div>

                    <div id="luck-controls" class="hidden text-center mt-4">
                         <div class="flex items-center justify-center gap-4">
                            <button id="rollBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-5 rounded-md transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-800 focus:ring-green-500" disabled>
                                Roll
                            </button>
                            <p class="text-slate-400">Kills: <span id="killCounter" class="font-bold text-white">0</span></p>
                        </div>
                        <p id="luck-item-info" class="text-xs text-slate-500 mt-2"></p>
                    </div>

                    <div id="luck-results" class="mt-6 text-center">
                        <!-- Results will be displayed here -->
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script src="changelog.js" defer></script>
    <script src="sidebar.js" defer></script>
    <script src="Equipment.js" defer></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DATA SETUP ---
            const statRollData = {
                "Ranged Weapon": {
                    pools: {
                        line1: [
                            { name: 'Agility', min: 2, max: 3, suffix: '' }, { name: 'Dexterity', min: 2, max: 3, suffix: '' },
                            { name: 'Vitality', min: 2, max: 3, suffix: '' }, { name: 'Intelligence', min: 2, max: 3, suffix: '' },
                            { name: 'Strength', min: 2, max: 3, suffix: '' }, { name: 'Luck', min: 2, max: 3, suffix: '' },
                        ],
                        line23: [
                            { name: 'Atk%', group: 'percentAttack', min: 3, max: 5, suffix: '%' }, { name: 'Matk%', group: 'percentAttack', min: 3, max: 5, suffix: '%' },
                            { name: 'Damage Ranged', group: 'damageType', min: 7, max: 10, suffix: '%' }, { name: 'Damage Magic', group: 'damageType', min: 7, max: 10, suffix: '%' },
                            { name: 'Crit', group: 'critChance', min: 7, max: 10, suffix: '' },
                            { name: 'Crit Damage', group: 'critDamage', min: 7, max: 10, suffix: '%' },
                            { name: 'Leech', group: 'leech', min: 7, max: 10, suffix: '%' },
                        ]
                    },
                    selection: ['line1', 'line23', 'line23']
                },
                "Axe": { "type": "Melee Weapon" },
                "Dagger": { "type": "Melee Weapon" },
                "Mace": { "type": "Melee Weapon" },
                "Spear": { "type": "Melee Weapon" },
                "Sword": { "type": "Melee Weapon" },
                "Wand": { "type": "Melee Weapon" },
                "Book": { "type": "Melee Weapon" },
                "Bow": { "type": "Ranged Weapon" },
                "Melee Weapon": {
                    pools: {
                        line1: [
                            { name: 'Agility', min: 2, max: 3, suffix: '' }, { name: 'Dexterity', min: 2, max: 3, suffix: '' },
                            { name: 'Vitality', min: 2, max: 3, suffix: '' }, { name: 'Intelligence', min: 2, max: 3, suffix: '' },
                            { name: 'Strength', min: 2, max: 3, suffix: '' }, { name: 'Luck', min: 2, max: 3, suffix: '' },
                        ],
                        line23: [
                            { name: 'Atk%', group: 'percentAttack', min: 3, max: 5, suffix: '%' }, { name: 'Matk%', group: 'percentAttack', min: 3, max: 5, suffix: '%' },
                            { name: 'Damage Melee', group: 'damageType', min: 7, max: 10, suffix: '%' }, { name: 'Damage Magic', group: 'damageType', min: 7, max: 10, suffix: '%' },
                            { name: 'Crit', group: 'critChance', min: 7, max: 10, suffix: '' },
                            { name: 'Crit Damage', group: 'critDamage', min: 7, max: 10, suffix: '%' },
                            { name: 'Leech', group: 'leech', min: 7, max: 10, suffix: '%' },
                        ]
                    },
                    selection: ['line1', 'line23', 'line23']
                },
                "Chest": {
                    pools: {
                        line1: [
                            { name: 'Agility', min: 2, max: 3, suffix: '' }, { name: 'Dexterity', min: 2, max: 3, suffix: '' },
                            { name: 'Vitality', min: 2, max: 3, suffix: '' }, { name: 'Intelligence', min: 2, max: 3, suffix: '' },
                            { name: 'Strength', min: 2, max: 3, suffix: '' }, { name: 'Luck', min: 2, max: 3, suffix: '' },
                        ],
                        line23: [
                            { name: 'Hp%', group: 'resourcePercent', min: 7, max: 10, suffix: '%' }, { name: 'Mp%', group: 'resourcePercent', min: 7, max: 10, suffix: '%' },
                            { name: 'Def', group: 'defense', min: 3, max: 5, suffix: '' }, { name: 'Mdef', group: 'defense', min: 3, max: 5, suffix: '' },
                            { name: '-Physical Damage', group: 'damageReduction', min: 3, max: 5, suffix: '' }, { name: '-Magical Damage', group: 'damageReduction', min: 3, max: 5, suffix: '' },
                            { name: 'Healing Received', group: 'healing', min: 7, max: 10, suffix: '%' }
                        ]
                    },
                    selection: ['line1', 'line23', 'line23']
                },
                "Feet": {
                     pools: {
                        line1: [
                            { name: 'Agility', min: 2, max: 3, suffix: '' }, { name: 'Dexterity', min: 2, max: 3, suffix: '' },
                            { name: 'Vitality', min: 2, max: 3, suffix: '' }, { name: 'Intelligence', min: 2, max: 3, suffix: '' },
                            { name: 'Strength', min: 2, max: 3, suffix: '' }, { name: 'Luck', min: 2, max: 3, suffix: '' },
                        ],
                        line23: [
                            { name: 'Atk Speed', group: 'atkSpeed', min: 7, max: 10, suffix: '%' },
                            { name: 'Cast speed', group: 'castSpeed', min: 11, max: 15, suffix: '%' },
                            { name: 'Movement speed', group: 'moveSpeed', min: 7, max: 10, suffix: '%' }
                        ]
                    },
                    selection: ['line1', 'line23', 'line23']
                },
                "Legs": {
                    pools: {
                         line1: [
                            { name: 'Agility', min: 2, max: 3, suffix: '' }, { name: 'Dexterity', min: 2, max: 3, suffix: '' },
                            { name: 'Vitality', min: 2, max: 3, suffix: '' }, { name: 'Intelligence', min: 2, max: 3, suffix: '' },
                            { name: 'Strength', min: 2, max: 3, suffix: '' }, { name: 'Luck', min: 2, max: 3, suffix: '' },
                        ],
                        line23: [
                            { name: 'Hp Regen', group: 'regen', min: 17, max: 25, suffix: '%' }, { name: 'Mp regen', group: 'regen', min: 17, max: 25, suffix: '%' },
                            { name: 'Flee', group: 'flee', min: 11, max: 15, suffix: '' },
                            { name: '-MpCost', group: 'mpCost', min: 7, max: 10, suffix: '%' },
                            { name: 'Leech', group: 'leech', min: 7, max: 10, suffix: '%' }
                        ]
                    },
                    selection: ['line1', 'line23', 'line23']
                },
                "Accessory": {
                    pools: {
                         line1: [
                            { name: 'Agility', min: 2, max: 3, suffix: '' }, { name: 'Dexterity', min: 2, max: 3, suffix: '' },
                            { name: 'Vitality', min: 2, max: 3, suffix: '' }, { name: 'Intelligence', min: 2, max: 3, suffix: '' },
                            { name: 'Strength', min: 2, max: 3, suffix: '' }, { name: 'Luck', min: 2, max: 3, suffix: '' },
                        ],
                        line23: [
                            { name: 'Hp%', group: 'resourcePercent', min: 1, max: 2, suffix: '%' }, { name: 'Mp%', group: 'resourcePercent', min: 1, max: 2, suffix: '%' },
                            { name: 'Atk%', group: 'percentAttack', min: 1, max: 2, suffix: '%' }, { name: 'Matk%', group: 'percentAttack', min: 1, max: 2, suffix: '%' },
                        ]
                    },
                    selection: ['line1', 'line23', 'line23']
                },
                 "Back": { "type": "Accessory" },
                 "Eyewear": { "type": "Accessory" },
                 "Head": { "type": "Accessory" },
                 "Shield": { "type": "Accessory" },
            };

            let statDetails = {};
            const equipmentSelect = document.getElementById('equipmentType');
            const statSelects = [document.getElementById('stat1'), document.getElementById('stat2'), document.getElementById('stat3')];
            const calculateBtn = document.getElementById('calculateBtn');
            const resultsDiv = document.getElementById('results');
            const errorDiv = document.getElementById('error-message');
            const errorText = document.getElementById('error-text');

            // --- MATH HELPER ---
            function combinations(n, k) {
                if (k < 0 || k > n) return 0;
                if (k === 0 || k === n) return 1;
                if (k > n / 2) k = n - k;
                let res = 1;
                for (let i = 1; i <= k; i++) {
                    res = res * (n - i + 1) / i;
                }
                return Math.round(res);
            }

            // --- UI INITIALIZATION & UPDATES ---
            function init() {
                const equipmentTypesForCalc = Object.keys(statRollData).filter(key => statRollData[key].pools);
                equipmentTypesForCalc.forEach(name => {
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = name;
                    equipmentSelect.appendChild(option);
                });

                equipmentSelect.addEventListener('change', () => updateUIForEquipment(equipmentSelect.value));
                calculateBtn.addEventListener('click', handleCalculate);
                statSelects.forEach(sel => sel.addEventListener('change', handleSelectChange));

                updateUIForEquipment(equipmentSelect.value);
            }

            function updateUIForEquipment(equipmentName) {
                const equipment = statRollData[equipmentName];
                statDetails = {}; // Clear old details

                // Rebuild statDetails map for current equipment
                Object.values(equipment.pools).flat().forEach(s => statDetails[s.name] = s);

                statSelects.forEach((select, index) => {
                    const poolName = equipment.selection[index];
                    const statList = equipment.pools[poolName];
                    populateSelect(select, statList, `Select Stat ${index + 1}`);
                });

                resultsDiv.classList.add('hidden');
                hideError();
            }

            function populateSelect(select, statList, placeholder) {
                select.innerHTML = `<option value="">${placeholder}</option>`;
                statList.forEach(stat => {
                    const option = document.createElement('option');
                    option.value = stat.name;
                    option.textContent = stat.name;
                    select.appendChild(option);
                });
            }

            function handleSelectChange() {
                // Get all selections, including empty ones, to preserve indices
                const allSelections = statSelects.map(s => statDetails[s.value]);

                statSelects.forEach((currentSelect, currentIndex) => {
                    // For the current dropdown, find selections made in OTHER dropdowns
                    const otherSelections = allSelections.filter((sel, index) => sel && index !== currentIndex);

                    // Loop through the options of the current dropdown
                    for (const option of currentSelect.options) {
                        if (option.value === "") continue;

                        const optionStat = statDetails[option.value];
                        if (!optionStat) continue;

                        // Start by assuming the option is enabled
                        option.disabled = false;

                        // Check for conflicts with selections in OTHER dropdowns
                        // A group is taken if another selection has the same group (and groups are defined)
                        const isGroupTaken = otherSelections.some(sel => sel.group && optionStat.group && sel.group === optionStat.group);
                        // A specific stat is taken if another selection is the exact same stat
                        const isStatTaken = otherSelections.some(sel => sel.name === optionStat.name);

                        if (isGroupTaken || isStatTaken) {
                            option.disabled = true;
                        }
                    }
                });

                // If a change causes a selected item to become disabled (e.g. selecting a conflicting stat in another box), reset it.
                statSelects.forEach(select => {
                    if (select.options[select.selectedIndex]?.disabled) {
                        select.value = "";
                    }
                });

                // Hide placeholder if a selection is made
                statSelects.forEach(select => {
                    const placeholderOption = select.querySelector('option[value=""]');
                    if (placeholderOption) {
                        placeholderOption.hidden = !!select.value;
                    }
                });
            }

            // --- CALCULATION LOGIC ---
            function handleCalculate() {
                const selectedNames = statSelects.map(s => s.value);
                if (selectedNames.some(name => !name)) {
                    showError("Please select three stats.");
                    return;
                }

                const selectedStats = selectedNames.map(name => statDetails[name]);

                // Custom check for weapon, which has distinct pools
                if (statRollData[equipmentSelect.value].selection[0] === 'line1') {
                    const line1Group = selectedStats[0].group; // will be undefined
                    const line23Groups = new Set([selectedStats[1].group, selectedStats[2].group]);
                     if (line23Groups.size < 2) {
                        showError("Stat 2 and Stat 3 must be from different groups.");
                        return;
                    }
                } else { // Generic check for items with one big pool
                     const uniqueGroups = new Set(selectedStats.map(s => s.group));
                     if (uniqueGroups.size < 3) {
                         showError("Selected stats must be from different groups.");
                         return;
                    }
                }


                hideError();

                const equipmentName = equipmentSelect.value;
                const anyRollProb = calculateProbability(equipmentName, selectedNames, false);
                const perfectRollProb = calculateProbability(equipmentName, selectedNames, true);

                displayResults(anyRollProb, perfectRollProb);
            }

            function getStatsInGroup(group, equipmentName, poolName) {
                 const equipment = statRollData[equipmentName];
                 const pool = equipment.pools[poolName] || [];
                 return pool.filter(s => s.group === group).length;
            }

            function calculateProbability(equipmentName, statNames, isPerfect) {
                const equipment = statRollData[equipmentName];
                const stats = statNames.map(name => statDetails[name]);

                let totalProb = 1;
                let breakdown = [];

                // All equipment now follows the same logic
                // Line 1
                const s1 = stats[0];
                let p1 = 1 / equipment.pools.line1.length;
                let p1Breakdown = `1/${equipment.pools.line1.length}`;
                if (isPerfect) {
                    p1 *= 1 / s1.values;
                    p1Breakdown += ` × 1/${s1.values}`;
                }
                totalProb *= p1;
                breakdown.push(`(${p1Breakdown} for ${s1.name})`);

                // Lines 2 & 3
                const s2 = stats[1];
                const s3 = stats[2];
                const line23pool = equipment.pools.line23 || [];
                const numGroups = new Set(line23pool.map(s => s.group)).size;
                const pGroupSelection = 1 / combinations(numGroups, 2);

                const s2GroupSize = getStatsInGroup(s2.group, equipmentName, 'line23');
                const s3GroupSize = getStatsInGroup(s3.group, equipmentName, 'line23');

                let p2 = 1 / s2GroupSize;
                let p3 = 1 / s3GroupSize;

                let p23Breakdown = `1/${combinations(numGroups, 2)} for groups`;
                if (isPerfect) {
                    p2 *= 1 / s2.values;
                    p3 *= 1 / s3.values;
                    p23Breakdown += ` × (1/${s2GroupSize} × 1/${s2.values}) × (1/${s3GroupSize} × 1/${s3.values})`;
                } else {
                    p23Breakdown += ` × 1/${s2GroupSize} × 1/${s3GroupSize}`;
                }
                totalProb *= pGroupSelection * p2 * p3;
                breakdown.push(`(${p23Breakdown})`);

                return {
                    prob: totalProb,
                    denominator: Math.round(1 / totalProb),
                    breakdown: breakdown.join(' × ')
                };
            }

            // --- DISPLAY & ERROR HANDLING ---
            function displayResults(any, perfect) {
                document.getElementById('any-roll-chance').textContent = `${(any.prob * 100).toFixed(4)}%`;
                document.getElementById('any-roll-fraction').textContent = `1 in ${any.denominator.toLocaleString()}`;
                document.getElementById('any-roll-breakdown').textContent = `Calc: ${any.breakdown}`;

                document.getElementById('perfect-roll-chance').textContent = `${(perfect.prob * 100).toFixed(4)}%`;
                document.getElementById('perfect-roll-fraction').textContent = `1 in ${perfect.denominator.toLocaleString()}`;
                document.getElementById('perfect-roll-breakdown').textContent = `Calc: ${perfect.breakdown}`;

                resultsDiv.classList.remove('hidden');
            }

            function showError(message) {
                errorText.textContent = message;
                errorDiv.classList.remove('hidden');
                resultsDiv.classList.add('hidden');
            }

            function hideError() {
                errorDiv.classList.add('hidden');
            }

            init();

            // --- "TRY YOUR LUCK?" FEATURE LOGIC ---
            const luckToggleBtn = document.getElementById('luckToggleBtn');
            const luckSection = document.getElementById('luck-section');
            const luckSearchInput = document.getElementById('luck-equipment-search');
            const luckDatalist = document.getElementById('equipment-luck-list');
            const luckControls = document.getElementById('luck-controls');
            const luckMonsterList = document.getElementById('luck-monster-list');
            const rollBtn = document.getElementById('rollBtn');
            const killCounterSpan = document.getElementById('killCounter');
            const luckItemInfo = document.getElementById('luck-item-info');
            const luckResults = document.getElementById('luck-results');
            const animationContainer = document.getElementById('animation-container');

            let killCount = 0;
            let selectedLuckItem = null;
            let selectedMonsterName = null;
            let monsterLootTable = [];

            const allMonsterLoot = {}; // Cache for all monster loot tables

            function buildAllMonsterLootTables() {
                equipmentData.forEach(item => {
                    if (!item.Source || !item.Droprate) return;

                    const sources = item.Source.split('\n');
                    const droprates = item.Droprate.split('\n');

                    sources.forEach((monsterName, index) => {
                        const trimmedName = monsterName.trim();
                        if (!trimmedName) return;

                        if (!allMonsterLoot[trimmedName]) {
                            allMonsterLoot[trimmedName] = [];
                        }

                        const droprate = parseFloat(droprates[index]);
                        if (!isNaN(droprate)) {
                            allMonsterLoot[trimmedName].push({
                                name: item.Name,
                                droprate: droprate / 100, // Store as decimal
                                spriteId: item.SpriteId,
                            });
                        }
                    });
                });
            }

            function triggerDropAnimation(item, startElement, isWishedItem) {
                const rect = startElement.getBoundingClientRect();
                const startX = rect.left + rect.width / 2;
                const startY = rect.top + rect.height / 2;

                const sprite = document.createElement('div');
                sprite.className = 'drop-animation';
                sprite.style.left = `${startX}px`;
                sprite.style.top = `${startY}px`;
                sprite.style.backgroundImage = `url('Sprites/Equipment/${item.spriteId}.png')`;

                const animationName = isWishedItem ? 'item-pickup' : 'item-drop';
                sprite.style.animation = `${animationName} 1s ease-out forwards`;

                animationContainer.appendChild(sprite);

                setTimeout(() => {
                    sprite.remove();
                }, 1000);
            }

            function initLuckFeature() {
                buildAllMonsterLootTables();
                const rollableTypes = Object.keys(statRollData);
                const validEquipment = equipmentData.filter(item => {
                    const baseType = item.Type;
                    const aliasedType = statRollData[baseType] ? statRollData[baseType].type : null;
                    return rollableTypes.includes(baseType) || (aliasedType && rollableTypes.includes(aliasedType));
                });

                validEquipment.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.Name;
                    luckDatalist.appendChild(option);
                });

                luckToggleBtn.addEventListener('click', () => {
                    luckSection.classList.toggle('hidden');
                });

                luckSearchInput.addEventListener('input', handleLuckEquipmentSelect);
                luckMonsterList.addEventListener('change', handleMonsterSelect);
                rollBtn.addEventListener('click', handleRoll);
            }

            function handleLuckEquipmentSelect() {
                const itemName = luckSearchInput.value;
                selectedLuckItem = equipmentData.find(item => item.Name === itemName);

                // Reset state
                luckMonsterList.innerHTML = '';
                luckMonsterList.classList.add('hidden');
                luckControls.classList.add('hidden');
                rollBtn.disabled = true;
                selectedMonsterName = null;
                monsterLootTable = [];

                if (selectedLuckItem && selectedLuckItem.Source && selectedLuckItem.Droprate) {
                    const sources = selectedLuckItem.Source.split('\n');
                    const droprates = selectedLuckItem.Droprate.split('\n');

                    if (sources.length > 0) {
                        let monsterHtml = '<p class="block text-sm font-medium text-gray-400 mb-2">Choose a Monster to Hunt:</p><div class="grid grid-cols-2 md:grid-cols-3 gap-2">';

                        sources.forEach((source, index) => {
                            const trimmedSource = source.trim();
                            if (trimmedSource === '') return;
                            const droprate = parseFloat(droprates[index]);
                            if (isNaN(droprate)) return;

                            monsterHtml += `
                                <label class="flex items-center bg-gray-700 p-3 rounded-md cursor-pointer hover:bg-gray-600">
                                    <input type="radio" name="monster" value="${trimmedSource}" class="h-4 w-4 text-purple-600 bg-gray-600 border-gray-500 focus:ring-purple-500">
                                    <span class="ml-3 text-sm text-white">${trimmedSource} (${droprate}%)</span>
                                </label>
                            `;
                        });
                        monsterHtml += '</div>';

                        luckMonsterList.innerHTML = monsterHtml;
                        luckMonsterList.classList.remove('hidden');
                    }
                }
            }

            function handleMonsterSelect(event) {
                if (event.target.name === 'monster') {
                    selectedMonsterName = event.target.value;
                    monsterLootTable = allMonsterLoot[selectedMonsterName] || [];

                    luckControls.classList.remove('hidden');
                    rollBtn.disabled = false;
                    luckResults.innerHTML = '';
                    killCount = 0;
                    killCounterSpan.textContent = killCount;
                }
            }

            function handleRoll() {
                if (!selectedLuckItem || !selectedMonsterName) return;

                killCount++;
                killCounterSpan.textContent = killCount;

                let wishedItemDropped = false;
                luckResults.innerHTML = ''; // Clear previous results on each roll

                monsterLootTable.forEach(item => {
                    if (Math.random() < item.droprate) {
                        const isWished = item.name === selectedLuckItem.Name;
                        if (isWished) {
                            wishedItemDropped = true;
                        }
                        triggerDropAnimation(item, rollBtn, isWished);
                    }
                });

                if (wishedItemDropped) {
                    const rolledStats = rollStatsForItem(selectedLuckItem);
                    luckResults.innerHTML = `
                        <div class="bg-green-900/50 border border-green-700 text-green-300 px-4 py-4 rounded-lg">
                            <h4 class="font-bold text-lg text-white">Success! You got the ${selectedLuckItem.Name}!</h4>
                            <p class="mt-2">Rolled Stats:</p>
                            <ul class="list-disc list-inside mt-1 font-mono">
                                ${rolledStats.map(stat => `<li>${stat}</li>`).join('')}
                            </ul>
                        </div>`;
                } else {
                    luckResults.innerHTML = `
                        <div class="bg-red-900/50 border border-red-700 text-red-300 px-4 py-3 rounded-lg">
                            <p>You did not get the weapon you wanted from this kill.</p>
                        </div>`;
                }
            }

            function getRandomElement(arr) {
                return arr[Math.floor(Math.random() * arr.length)];
            }

            function getRandomInt(min, max) {
                min = Math.ceil(min);
                max = Math.floor(max);
                return Math.floor(Math.random() * (max - min + 1)) + min;
            }

            function rollAndFormatStat(stat) {
                if (stat.min === undefined || stat.max === undefined) {
                    return stat.name; // Fallback for misconfigured stats
                }
                const value = getRandomInt(stat.min, stat.max);
                const sign = value >= 0 ? '+' : '';
                return `${stat.name} ${sign}${value}${stat.suffix || ''}`;
            }

            function rollStatsForItem(item) {
                // Get the rolling configuration for the item's type.
                let itemConfigKey = item.Type;
                let itemConfig = statRollData[itemConfigKey];

                // Handle aliased types (e.g., "Axe" uses "Melee Weapon" config)
                if (itemConfig && itemConfig.type) {
                    itemConfigKey = itemConfig.type;
                    itemConfig = statRollData[itemConfigKey];
                }

                if (!itemConfig || !itemConfig.pools) {
                    return ["Stat rolling not configured for this item type."];
                }

                const rolledStats = [];
                const usedGroups = new Set();

                // Roll Stat 1 from line1 pool
                const line1Pool = itemConfig.pools.line1;
                if (!line1Pool || line1Pool.length === 0) return ["Error: line1 pool is empty."];
                const stat1 = getRandomElement(line1Pool);
                rolledStats.push(rollAndFormatStat(stat1));
                if (stat1.group) usedGroups.add(stat1.group);

                // Roll Stat 2 & 3 from line23 pool
                const line23Pool = itemConfig.pools.line23;
                if (!line23Pool) return ["Error: line23 pool is missing."];

                // Filter for stat 2, excluding groups already used
                let availablePool2 = line23Pool.filter(s => !usedGroups.has(s.group));
                if (availablePool2.length === 0) return ["Error: Not enough stat groups for the second roll."];
                const stat2 = getRandomElement(availablePool2);
                rolledStats.push(rollAndFormatStat(stat2));
                if (stat2.group) usedGroups.add(stat2.group);

                // Filter for stat 3, excluding the group from stat 2
                let availablePool3 = availablePool2.filter(s => s.group !== stat2.group);
                if (availablePool3.length === 0) return ["Error: Not enough stat groups for the third roll."];
                const stat3 = getRandomElement(availablePool3);
                rolledStats.push(rollAndFormatStat(stat3));

                return rolledStats;
            }

            // `equipmentData` is loaded from the external Equipment.js file.
            // It is separate from `statRollData` which is defined in this script.
            initLuckFeature();
        });
    </script>
</body>
</html>