<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SpiritVale Stat Roll Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* gray-900 */
        }
        .custom-select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url('data:image/svg+xml;charset=UTF-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="none" stroke="%236b7280" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m6 8 4 4 4-4"/></svg>');
            background-size: 1.25rem;
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
        }
        .calculator-panel {
             background-color: #1f2937; /* gray-800 */
        }
        .multiselect-dropdown {
            position: relative;
        }
        .multiselect-dropdown-list {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            z-index: 10;
            background-color: #1f2937; /* gray-800 */
            border: 1px solid #374151; /* gray-700 */
            border-radius: 0.375rem; /* rounded-md */
            max-height: 200px;
            overflow-y: auto;
        }
        .multiselect-dropdown-list label {
            display: block;
            padding: 0.5rem 0.75rem;
            cursor: pointer;
        }
        .multiselect-dropdown-list label:hover {
            background-color: #374151; /* gray-700 */
        }
        .multiselect-dropdown-list input {
            margin-right: 0.5rem;
        }
        .multiselect-dropdown-list label:has(input:disabled) {
            opacity: 0.5;
            cursor: not-allowed;
            color: #9ca3af; /* gray-400 */
        }
    </style>
</head>
<body class="text-slate-300">

    <div class="min-h-screen flex flex-col items-center justify-center p-4">
        <!-- Main Content -->
        <main class="w-full max-w-2xl mx-auto">
            <header class="text-center mb-8">
                <h1 class="text-3xl md:text-4xl font-bold text-white">SpiritVale Stat Roll Calculator</h1>
                <p class="text-slate-400 mt-2">Select your equipment and desired stats to see the roll probability.</p>
            </header>

            <div class="calculator-panel shadow-lg rounded-xl p-6 md:p-8 border border-gray-700">
                <!-- Equipment Selection -->
                <div class="mb-6">
                    <label for="equipmentType" class="block text-sm font-medium text-slate-400 mb-2">Equipment Piece</label>
                    <select id="equipmentType" class="custom-select w-full bg-gray-900 border border-gray-700 rounded-md py-2.5 px-3 text-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                        <!-- Options will be populated by JS -->
                    </select>
                </div>

                <!-- Stat Selection Form -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div>
                        <label for="stat1" class="block text-sm font-medium text-slate-400 mb-2">Stat 1</label>
                        <div id="stat1-multiselect" class="multiselect-dropdown">
                            <button class="custom-select w-full bg-gray-900 border border-gray-700 rounded-md py-2.5 px-3 text-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition text-left">Select Stat 1</button>
                            <div class="multiselect-dropdown-list"></div>
                        </div>
                    </div>
                    <div>
                        <label for="stat2" class="block text-sm font-medium text-slate-400 mb-2">Stat 2</label>
                        <div id="stat2-multiselect" class="multiselect-dropdown">
                            <button class="custom-select w-full bg-gray-900 border border-gray-700 rounded-md py-2.5 px-3 text-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition text-left">Select Stat 2</button>
                            <div class="multiselect-dropdown-list"></div>
                        </div>
                    </div>
                    <div>
                        <label for="stat3" class="block text-sm font-medium text-slate-400 mb-2">Stat 3</label>
                         <div id="stat3-multiselect" class="multiselect-dropdown">
                            <button class="custom-select w-full bg-gray-900 border border-gray-700 rounded-md py-2.5 px-3 text-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition text-left">Select Stat 3</button>
                            <div class="multiselect-dropdown-list"></div>
                        </div>
                    </div>
                </div>

                <!-- Calculate Button -->
                <div class="text-center my-8">
                    <button id="calculateBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-md transition-colors w-full md:w-auto">
                        Calculate Probability
                    </button>
                </div>

                <!-- Error Message -->
                <div id="error-message" class="hidden text-center bg-red-900/50 border border-red-700 text-red-300 px-4 py-3 rounded-lg mb-6">
                    <p id="error-text"></p>
                </div>

                <!-- Results Section -->
                <div id="results" class="hidden">
                     <hr class="border-gray-700 my-6">
                    <h2 class="text-xl font-semibold text-center mb-6 text-white">Calculation Results</h2>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Scenario 1: Any Roll -->
                        <div class="border border-gray-700 rounded-lg p-4 flex flex-col">
                            <h3 class="text-md font-medium text-blue-400 mb-3 text-center">Chance for Right Stats (Any Roll)</h3>
                            <div id="any-roll-results-container" class="space-y-4 mt-auto">
                                <!-- Results for single and combined will be dynamically inserted here -->
                            </div>
                        </div>

                        <!-- Scenario 2: Perfect Roll -->
                        <div class="border border-gray-700 rounded-lg p-4 flex flex-col">
                            <h3 class="text-md font-medium text-blue-400 mb-3 text-center">Chance for Perfect Roll (Max Values)</h3>
                             <div id="perfect-roll-results-container" class="space-y-4 mt-auto">
                                <!-- Results for single and combined will be dynamically inserted here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
             <footer class="text-center mt-6">
                <p class="text-xs text-slate-500">Probabilities are based on the assumption of equal chances for each outcome within a stat group.</p>
            </footer>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DATA SETUP ---
            const equipmentData = {
                "Ranged Weapon": {
                    pools: {
                        line1: [
                            { name: 'Agility', values: 2 }, { name: 'Dexterity', values: 2 },
                            { name: 'Vitality', values: 2 }, { name: 'Intelligence', values: 2 },
                            { name: 'Strength', values: 2 }, { name: 'Luck', values: 2 },
                        ],
                        line23: [
                            { name: 'Atk%', group: 'percentAttack', values: 3 }, { name: 'Matk%', group: 'percentAttack', values: 3 },
                            { name: 'Damage Ranged', group: 'damageType', values: 4 }, { name: 'Damage Magic', group: 'damageType', values: 4 },
                            { name: 'Crit', group: 'critChance', values: 4 },
                            { name: 'Crit Damage', group: 'critDamage', values: 4 },
                            { name: 'Leech', group: 'leech', values: 4 },
                        ]
                    },
                    selection: ['line1', 'line23', 'line23']
                },
                "Melee Weapon": {
                    pools: {
                        line1: [
                            { name: 'Agility', values: 2 }, { name: 'Dexterity', values: 2 },
                            { name: 'Vitality', values: 2 }, { name: 'Intelligence', values: 2 },
                            { name: 'Strength', values: 2 }, { name: 'Luck', values: 2 },
                        ],
                        line23: [
                            { name: 'Atk%', group: 'percentAttack', values: 3 }, { name: 'Matk%', group: 'percentAttack', values: 3 },
                            { name: 'Damage Melee', group: 'damageType', values: 4 }, { name: 'Damage Magic', group: 'damageType', values: 4 },
                            { name: 'Crit', group: 'critChance', values: 4 },
                            { name: 'Crit Damage', group: 'critDamage', values: 4 },
                            { name: 'Leech', group: 'leech', values: 4 },
                        ]
                    },
                    selection: ['line1', 'line23', 'line23']
                },
                "Chest": {
                    pools: {
                        line1: [
                            { name: 'Agility', values: 2 }, { name: 'Dexterity', values: 2 },
                            { name: 'Vitality', values: 2 }, { name: 'Intelligence', values: 2 },
                            { name: 'Strength', values: 2 }, { name: 'Luck', values: 2 },
                        ],
                        line23: [
                            { name: 'Hp%', group: 'resourcePercent', values: 4 }, { name: 'Mp%', group: 'resourcePercent', values: 4 }, // 7-10
                            { name: 'Def', group: 'defense', values: 3 }, { name: 'Mdef', group: 'defense', values: 3 }, // 3-5
                            { name: '-Physical Damage', group: 'damageReduction', values: 3 }, { name: '-Magical Damage', group: 'damageReduction', values: 3 }, // 3-5
                            { name: 'Healing Received', group: 'healing', values: 4 } // 7-10
                        ]
                    },
                    selection: ['line1', 'line23', 'line23']
                },
                "Feet": {
                     pools: {
                        line1: [
                            { name: 'Agility', values: 2 }, { name: 'Dexterity', values: 2 },
                            { name: 'Vitality', values: 2 }, { name: 'Intelligence', values: 2 },
                            { name: 'Strength', values: 2 }, { name: 'Luck', values: 2 },
                        ],
                        line23: [
                            { name: 'Atk Speed', group: 'atkSpeed', values: 4 }, // 7-10
                            { name: 'Cast speed', group: 'castSpeed', values: 5 }, // 11-15
                            { name: 'Movement speed', group: 'moveSpeed', values: 4 } // 7-10
                        ]
                    },
                    selection: ['line1', 'line23', 'line23']
                },
                "Legs": {
                    pools: {
                         line1: [
                            { name: 'Agility', values: 2 }, { name: 'Dexterity', values: 2 },
                            { name: 'Vitality', values: 2 }, { name: 'Intelligence', values: 2 },
                            { name: 'Strength', values: 2 }, { name: 'Luck', values: 2 },
                        ],
                        line23: [
                            { name: 'Hp Regen', group: 'regen', values: 9 }, { name: 'Mp regen', group: 'regen', values: 9 }, // 17-25
                            { name: 'Flee', group: 'flee', values: 5 }, // 11-15
                            { name: '-MpCost', group: 'mpCost', values: 4 }, // 7-10
                            { name: 'Leech', group: 'leech', values: 4 } // 7-10
                        ]
                    },
                    selection: ['line1', 'line23', 'line23']
                },
                "Accessory": {
                    pools: {
                         line1: [
                            { name: 'Agility', values: 2 }, { name: 'Dexterity', values: 2 },
                            { name: 'Vitality', values: 2 }, { name: 'Intelligence', values: 2 },
                            { name: 'Strength', values: 2 }, { name: 'Luck', values: 2 },
                        ],
                        line23: [
                            { name: 'Hp%', group: 'resourcePercent', values: 2 }, { name: 'Mp%', group: 'resourcePercent', values: 2 }, // 1-2
                            { name: 'Atk%', group: 'percentAttack', values: 2 }, { name: 'Matk%', group: 'percentAttack', values: 2 }, // 1-2
                        ]
                    },
                    selection: ['line1', 'line23', 'line23']
                }
            };

            let statDetails = {};
            let selectedStats = [[], [], []]; // Array of arrays for selected stat names
            const equipmentSelect = document.getElementById('equipmentType');
            const multiSelectContainers = [
                document.getElementById('stat1-multiselect'),
                document.getElementById('stat2-multiselect'),
                document.getElementById('stat3-multiselect')
            ];
            const calculateBtn = document.getElementById('calculateBtn');
            const resultsDiv = document.getElementById('results');
            const errorDiv = document.getElementById('error-message');
            const errorText = document.getElementById('error-text');

            // --- MATH HELPER ---
            function combinations(n, k) {
                if (k < 0 || k > n) return 0;
                if (k === 0 || k === n) return 1;
                if (k > n / 2) k = n - k;
                let res = 1;
                for (let i = 1; i <= k; i++) {
                    res = res * (n - i + 1) / i;
                }
                return Math.round(res);
            }

            // --- UI INITIALIZATION & UPDATES ---
            function init() {
                Object.keys(equipmentData).forEach(name => {
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = name;
                    equipmentSelect.appendChild(option);
                });

                equipmentSelect.addEventListener('change', () => updateUIForEquipment(equipmentSelect.value));
                calculateBtn.addEventListener('click', handleCalculate);

                multiSelectContainers.forEach((container, index) => {
                    const button = container.querySelector('button');
                    const list = container.querySelector('.multiselect-dropdown-list');

                    button.addEventListener('click', (e) => {
                        e.stopPropagation();
                        toggleDropdown(index);
                    });

                    // Prevent dropdown from closing when clicking inside the list
                    list.addEventListener('click', (e) => {
                        e.stopPropagation();
                    });
                });

                document.addEventListener('click', closeAllDropdowns);
                updateUIForEquipment(equipmentSelect.value);
            }

            function updateUIForEquipment(equipmentName) {
                const equipment = equipmentData[equipmentName];
                statDetails = {}; // Clear old details
                selectedStats = [[], [], []]; // Reset selections

                Object.values(equipment.pools).flat().forEach(s => statDetails[s.name] = s);

                multiSelectContainers.forEach((container, index) => {
                    const poolName = equipment.selection[index];
                    const statList = equipment.pools[poolName];
                    populateMultiSelect(container, statList, index);
                    updateButtonText(index);
                });
                updateCheckboxDisabledStates();

                resultsDiv.classList.add('hidden');
                hideError();
            }

            function populateMultiSelect(container, statList, selectIndex) {
                const list = container.querySelector('.multiselect-dropdown-list');
                list.innerHTML = '';
                statList.forEach(stat => {
                    const label = document.createElement('label');
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.value = stat.name;
                    checkbox.addEventListener('change', () => {
                        handleCheckboxChange(selectIndex, stat.name, checkbox.checked);
                    });
                    label.appendChild(checkbox);
                    label.append(stat.name);
                    list.appendChild(label);
                });
            }

            function toggleDropdown(index) {
                const list = multiSelectContainers[index].querySelector('.multiselect-dropdown-list');
                const isVisible = list.style.display === 'block';
                closeAllDropdowns();
                if (!isVisible) {
                    list.style.display = 'block';
                }
            }

            function closeAllDropdowns() {
                multiSelectContainers.forEach(container => {
                    container.querySelector('.multiselect-dropdown-list').style.display = 'none';
                });
            }

            function handleCheckboxChange(selectIndex, statName, isChecked) {
                if (isChecked) {
                    selectedStats[selectIndex].push(statName);
                } else {
                    selectedStats[selectIndex] = selectedStats[selectIndex].filter(s => s !== statName);
                }
                updateButtonText(selectIndex);
                updateCheckboxDisabledStates();
            }

            function updateCheckboxDisabledStates() {
                const selectionsBySlot = selectedStats.map((slot, index) =>
                    slot.map(statName => ({ ...statDetails[statName], slotIndex: index }))
                );

                const allSelectedGroups = selectionsBySlot.flat().map(s => s.group).filter(Boolean);

                multiSelectContainers.forEach((container, containerIndex) => {
                    const list = container.querySelector('.multiselect-dropdown-list');
                    const selectionsInThisSlot = selectionsBySlot[containerIndex];
                    const groupsInThisSlot = selectionsInThisSlot.map(s => s.group).filter(Boolean);

                    list.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                        const statName = checkbox.value;
                        const stat = statDetails[statName];

                        checkbox.disabled = false; // Reset first

                        // Rule 1: A stat is selected in another slot.
                        const conflictAcrossSlots = selectionsBySlot.flat().find(s =>
                            s.slotIndex !== containerIndex && ((s.group && s.group === stat.group) || s.name === stat.name)
                        );
                        if (conflictAcrossSlots) {
                            checkbox.disabled = true;
                            return;
                        }

                        // Rule 2: A different group is already selected in THIS slot.
                        if (groupsInThisSlot.length > 0 && stat.group && !groupsInThisSlot.includes(stat.group)) {
                            checkbox.disabled = true;
                        }
                    });
                });
            }

            function updateButtonText(index) {
                const button = multiSelectContainers[index].querySelector('button');
                const currentSelections = selectedStats[index];
                if (currentSelections.length === 0) {
                    button.textContent = `Select Stat ${index + 1}`;
                } else if (currentSelections.length === 1) {
                    button.textContent = currentSelections[0];
                } else {
                    button.textContent = `${currentSelections.length} stats selected`;
                }
            }

            // --- CALCULATION LOGIC ---
            function handleCalculate() {
                // selectedStats is now an array of arrays: [[stat1a, stat1b], [stat2a], [stat3a]]
                if (selectedStats.some(slot => slot.length === 0)) {
                    showError("Please select at least one stat for each slot.");
                    return;
                }

                // For now, we will calculate based on the FIRST selection in each slot.
                // This will be expanded in the next step.
                const primarySelectedNames = selectedStats.map(slot => slot[0]);
                const primarySelectedStats = primarySelectedNames.map(name => statDetails[name]);

                // Custom check for weapon, which has distinct pools
                if (equipmentData[equipmentSelect.value].selection[0] === 'line1') {
                    const line23Groups = new Set([primarySelectedStats[1].group, primarySelectedStats[2].group]);
                     if (line23Groups.size < 2) {
                        showError("Stat 2 and Stat 3 must be from different groups.");
                        return;
                    }
                } else { // Generic check for items with one big pool
                     const uniqueGroups = new Set(primarySelectedStats.map(s => s.group));
                     if (uniqueGroups.size < 3) {
                         showError("Selected stats must be from different groups.");
                         return;
                    }
                }

                hideError();

                const equipmentName = equipmentSelect.value;

                // 1. Calculate for the "single" combination (first selected stat in each slot)
                const singleStatNames = selectedStats.map(s => [s[0]]); // Wrap in array for the new function
                const singleAnyRoll = calculateProbability(equipmentName, singleStatNames, false);
                const singlePerfectRoll = calculateProbability(equipmentName, singleStatNames, true);

                // 2. Calculate for the "combined" combination (all selected stats)
                const combinedAnyRoll = calculateProbability(equipmentName, selectedStats, false);
                const combinedPerfectRoll = calculateProbability(equipmentName, selectedStats, true);

                const results = {
                    single: { any: singleAnyRoll, perfect: singlePerfectRoll },
                    combined: { any: combinedAnyRoll, perfect: combinedPerfectRoll }
                };

                displayResults(results);
            }

            function getStatsInGroup(group, equipmentName, poolName) {
                 const equipment = equipmentData[equipmentName];
                 const pool = equipment.pools[poolName] || [];
                 return pool.filter(s => s.group === group).length;
            }

            function calculateProbability(equipmentName, statNameArrays, isPerfect) {
                const equipment = equipmentData[equipmentName];
                const statObjectArrays = statNameArrays.map(slot => slot.map(name => statDetails[name]));

                // --- Probability for Slot 1 ---
                const slot1Options = statObjectArrays[0];
                let probSlot1 = 0;
                slot1Options.forEach(stat => {
                    let p = 1 / equipment.pools.line1.length; // Chance to get the stat
                    if (isPerfect) {
                        p *= 1 / stat.values; // Chance for a perfect roll on that stat
                    }
                    probSlot1 += p;
                });

                // --- Probability for Slots 2 & 3 ---
                const slot2Options = statObjectArrays[1];
                const slot3Options = statObjectArrays[2];

                // Since the UI now enforces that slot 2 and 3 have different, valid groups,
                // we can simplify the calculation.
                const line23pool = equipment.pools.line23 || [];
                const numGroupsInPool = new Set(line23pool.map(s => s.group)).size;

                // The probability of selecting the two correct groups for slot 2 and 3
                const probOfCorrectGroupPair = 1 / combinations(numGroupsInPool, 2);

                // Probability within the chosen groups
                let probSlot2 = 0;
                slot2Options.forEach(stat => {
                    const groupSize = getStatsInGroup(stat.group, equipmentName, 'line23');
                    let p = 1 / groupSize; // Chance to get the stat within its group
                    if (isPerfect) {
                        p *= 1 / stat.values;
                    }
                    probSlot2 += p;
                });

                let probSlot3 = 0;
                slot3Options.forEach(stat => {
                    const groupSize = getStatsInGroup(stat.group, equipmentName, 'line23');
                    let p = 1 / groupSize;
                    if (isPerfect) {
                        p *= 1 / stat.values;
                    }
                    probSlot3 += p;
                });

                // The total probability for slots 2 and 3 is the chance to get the right groups,
                // multiplied by the chances of getting the right stats within those groups.
                const probSlots2and3 = probOfCorrectGroupPair * probSlot2 * probSlot3;

                // --- Final Probability ---
                const totalProb = probSlot1 * probSlots2and3;
                const denominator = totalProb > 0 ? Math.round(1 / totalProb) : Infinity;

                return {
                    prob: totalProb,
                    denominator: denominator,
                    breakdown: "Calculation refactored for clarity."
                };
            }

            // --- DISPLAY & ERROR HANDLING ---
            function displayResults(results) {
                const anyRollContainer = document.getElementById('any-roll-results-container');
                const perfectRollContainer = document.getElementById('perfect-roll-results-container');

                anyRollContainer.innerHTML = createResultHTML('Single Combination', results.single.any);
                perfectRollContainer.innerHTML = createResultHTML('Single Combination', results.single.perfect);

                // Only show combined results if there's actually a multi-stat selection
                const hasMultiSelection = selectedStats.some(s => s.length > 1);
                if (hasMultiSelection) {
                    anyRollContainer.innerHTML += createResultHTML('Combined (Any Selected)', results.combined.any);
                    perfectRollContainer.innerHTML += createResultHTML('Combined (Any Selected)', results.combined.perfect);
                }

                resultsDiv.classList.remove('hidden');
            }

            function createResultHTML(title, data) {
                const { prob, denominator } = data;
                const percentage = (prob * 100).toFixed(4);
                const fraction = `1 in ${denominator.toLocaleString()}`;

                return `
                    <div class="bg-gray-900/50 p-4 rounded-lg border border-gray-700">
                        <h4 class="text-sm font-semibold text-slate-300 mb-2 text-center">${title}</h4>
                        <p class="text-2xl font-bold text-center text-white">${percentage}%</p>
                        <p class="text-center text-slate-400 mt-1">${fraction}</p>
                    </div>
                `;
            }

            function showError(message) {
                errorText.textContent = message;
                errorDiv.classList.remove('hidden');
                resultsDiv.classList.add('hidden');
            }

            function hideError() {
                errorDiv.classList.add('hidden');
            }

            init();
        });
    </script>
</body>
</html>