<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game Database</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom scrollbar for better aesthetics in dark mode */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1f2937;
        }
        ::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }
        /* Tooltip styles */
        #tooltip {
            position: absolute;
            display: none;
            padding: 10px;
            background-color: #111827;
            border: 1px solid #374151;
            border-radius: 8px;
            color: #d1d5db;
            font-size: 0.875rem;
            z-index: 100;
            pointer-events: none; /* Allows mouse events to pass through */
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            min-width: 200px;
        }
        /* Expanding Search Bar Styles */
        .search-wrapper .search-input {
            transition: width 0.3s ease-in-out;
        }
        .search-wrapper:hover .search-input,
        .search-input:focus,
        .search-input.expanded {
            width: 256px; /* w-64 */
        }
        @keyframes highlight-glow {
            0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); }
            50% { box-shadow: 0 0 20px 10px rgba(59, 130, 246, 0); }
            100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
        }
        .highlight-effect {
            animation: highlight-glow 2s ease-out;
            border-color: rgba(59, 130, 246, 0.8) !important; /* Use important to override existing styles */
        }
        /* Custom select styling */
        .filter-select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url('data:image/svg+xml;charset=UTF-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="none" stroke="%239ca3af" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9l4 4 4-4"/></svg>');
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1em;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-300">

    <div id="sidebar"></div>

    <!-- Main Content -->
    <main id="main-content" class="px-4 md:px-8">
            <div id="content-container">
                <!-- Equipment Content (Visible by default) -->
                <section id="equipment" class="content-section">
                    <div class="sticky top-0 z-10 bg-gray-900 py-4 flex flex-wrap items-center gap-4 mb-6">
                        <h1 class="text-3xl font-bold text-white">Equipment</h1>
                        <div class="search-wrapper relative">
                            <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                                <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                            </div>
                            <input type="search" id="equipment-search" class="search-input block w-10 h-10 p-2 pl-10 text-sm text-gray-300 bg-gray-700 rounded-full border border-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="Search Equipment...">
                        </div>
                        <div class="relative">
                            <select id="equipment-type-filter" class="filter-select block w-48 h-10 px-4 text-sm text-gray-300 bg-gray-700 rounded-full border border-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 cursor-pointer">
                                <option value="all">All Types</option>
                            </select>
                        </div>
                    </div>
                    <div id="equipment-list"></div>
                </section>

                <!-- Cards Content (Hidden by default) -->
                <section id="cards" class="content-section hidden">
                     <div class="sticky top-0 z-10 bg-gray-900 py-4 flex flex-wrap items-center gap-4 mb-6">
                        <h1 class="text-3xl font-bold text-white">Cards</h1>
                        <div class="search-wrapper relative">
                            <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                                <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                            </div>
                            <input type="search" id="cards-search" class="search-input block w-10 h-10 p-2 pl-10 text-sm text-gray-300 bg-gray-700 rounded-full border border-gray-600 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500" placeholder="Search Cards...">
                        </div>
                       <div class="relative">
                            <select id="card-slot-filter" class="filter-select block w-48 h-10 px-4 text-sm text-gray-300 bg-gray-700 rounded-full border border-gray-600 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500 cursor-pointer">
                                <option value="all">All Slots</option>
                            </select>
                        </div>
                    </div>
                    <div id="cards-list"></div>
                </section>

                <!-- Artifacts Content (Hidden by default) -->
                <section id="artifacts" class="content-section hidden">
                    <div class="sticky top-0 z-10 bg-gray-900 py-4 flex items-center mb-6">
                        <h1 class="text-3xl font-bold text-white">Artifacts</h1>
                        <div class="search-wrapper relative ml-4">
                            <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                                <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                            </div>
                            <input type="search" id="artifacts-search" class="search-input block w-10 h-10 p-2 pl-10 text-sm text-gray-300 bg-gray-700 rounded-full border border-gray-600 focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-teal-500" placeholder="Search Artifacts...">
                        </div>
                    </div>
                    <div id="artifacts-list"></div>
                </section>

                <!-- Monsters Content (Hidden by default) -->
                <section id="monsters" class="content-section hidden">
                    <div class="sticky top-0 z-10 bg-gray-900 py-4 flex items-center mb-6">
                        <h1 class="text-3xl font-bold text-white">Monsters</h1>
                        <div class="search-wrapper relative ml-4">
                            <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                                <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                            </div>
                            <input type="search" id="monsters-search" class="search-input block w-10 h-10 p-2 pl-10 text-sm text-gray-300 bg-gray-700 rounded-full border border-gray-600 focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-red-500" placeholder="Search Monsters...">
                        </div>
                    </div>
                    <div id="monsters-list"></div>
                </section>
            </div>
        </main>
    </div>

    <!-- Monster Details Modal -->
    <div id="monster-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 hidden z-50">
        <div id="monster-modal-content" class="bg-gray-800 rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] flex flex-col border border-gray-700">
            <div class="p-4 border-b border-gray-700 relative flex justify-center items-center flex-shrink-0">
                <h2 id="monster-modal-name" class="text-2xl font-bold text-white text-center">Monster Details</h2>
                <button id="monster-modal-close" class="absolute top-0 right-0 mt-4 mr-4 text-gray-400 hover:text-white text-3xl leading-none">&times;</button>
            </div>
            <div class="p-6 flex-grow overflow-y-auto">
                <div id="monster-modal-details" class="mb-6"></div>
                <div>
                    <h3 class="text-xl font-semibold text-white mb-4">Loot Drops</h3>
                    <div id="monster-modal-loot" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tooltip Element -->
    <div id="tooltip"></div>
    <script src="sidebar.js" defer></script>
    <script src="Equipment.js" defer></script>
    <script src="Cards.js" defer></script>
    <script src="Artifacts.js" defer></script>
    <script src="monsters.js" defer></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Data is now loaded from the deferred scripts above.
            // Assign 'monsters' from monsters.js to 'monsterData' for compatibility with existing code.
            const monsterData = monsters;

            try {
                // --- UTILITY FUNCTIONS ---

                const elementColors = {
                    "Neutral": "#FFFFFFFF",
                    "Poison": "#8CD470FF",
                    "Holy": "#FCE9EBFF",
                    "Shadow": "#755E94FF",
                    "Fire": "#FF7026FF",
                    "Water": "#79D7FDFF",
                    "Wind": "#FFC701FF",
                    "Earth": "#BB7B2FFF",
                    "Undead": "#C85AE0FF",
                };

                const elementalChart = {
                    // Attacker: { Defender: Multiplier }
                    "Neutral": { "Shadow": 1.25, "Holy": 0.75 },
                    "Poison": { "Neutral": 1.25, "Holy": 0.75, "Undead": 0.75, "Poison": 0.5 },
                    "Holy": { "Undead": 1.25, "Shadow": 1.25, "Holy": 0.5 },
                    "Shadow": { "Holy": 1.25, "Poison": 0.75, "Shadow": 0.5 },
                    "Fire": { "Earth": 1.25, "Poison": 1.25, "Water": 0.75, "Wind": 0.75, "Fire": 0.5 },
                    "Water": { "Fire": 1.25, "Undead": 0.75, "Earth": 0.75, "Water": 0.5 },
                    "Wind": { "Water": 1.25, "Neutral": 0.75, "Fire": 0.75, "Wind": 0.5 },
                    "Earth": { "Wind": 1.25, "Fire": 0.75, "Water": 0.75, "Earth": 0.5 },
                    "Undead": { "Poison": 1.25, "Holy": 0.75, "Undead": 0.5 },
                };

                function colorizeElement(element) {
                    const color = elementColors[element] || elementColors['Neutral'];
                    const hexColor = color.substring(1, 7); // Extract RRGGBB from #RRGGBBAA
                    return `<span style="color:#${hexColor};">${element}</span>`;
                }
                function parseStats(statString) {
                    if (!statString) return '<span class="text-gray-500">N/A</span>';
                    return statString
                        .replace(/<color=#([A-Fa-f0-9]{6})[A-Fa-f0-9]{2}>/g, (match, color) => `<span style="color:#${color};">`)
                        .replace(/<\/color>/g, '</span>')
                        .replace(/\n/g, '<br>');
                }

                function getMonsterNameHTML(monsterName, monsterData) {
                    const monster = monsterData.find(m => m.MonsterName === monsterName);
                    if (monster && monster.IsBoss) {
                        return `<span class="inline-flex items-center">
                                    <svg class="w-4 h-4 mr-1.5 text-red-400 boss-icon" data-tooltip-text="Boss Monster" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 15.93c-3.32-.15-6-2.9-6-6.22 0-1.12.3-2.16.82-3.07L12 15l-1 3.93zm6.44-3.19c-.43.92-1.05 1.7-1.82 2.3L12 12l6-4.18c.39.91.59 1.91.59 2.96 0 1.4-.35 2.7-.95 3.81zM12 4c1.01 0 1.95.24 2.8.65L12 8 9.2 4.65C10.05 4.24 10.99 4 12 4z"/></svg>
                                    ${monsterName}
                                </span>`;
                    }
                    return monsterName;
                }

                function renderSources(item, themeColor) {
                    if (!item.Source) return '';

                    const sources = item.Source.split('\n');
                    // Let's count non-empty sources to determine the label and grid
                    const nonEmptySources = sources.filter(s => s.trim() !== '');
                    if (nonEmptySources.length === 0) return '';

                    const droprates = item.Droprate ? item.Droprate.split('\n') : [];
                    const locations = item.Location ? item.Location.split('\n') : [];

                    let sourcesHtml = `<div class="mt-4 pt-4 border-t border-gray-700/50 text-xs text-gray-400">`;

                    const label = nonEmptySources.length === 1 ? 'Source' : 'Sources';
                    sourcesHtml += `<p class="text-xs text-gray-500 uppercase font-semibold mb-1">${label}</p>`;

                    // For multiple sources, use a 2-column grid. Otherwise, a single column list.
                    const gridClass = nonEmptySources.length > 1 ? 'grid grid-cols-2 gap-x-4' : '';
                    sourcesHtml += `<ul class="${gridClass} text-sm list-disc list-inside">`;

                    sources.forEach((source, index) => {
                        if (source.trim() === '') return; // Skip empty lines

                        const monsterName = source.replace(/^(Rune - |Gem - |Relic - |Scroll - )/, '');
                        const prefixMatch = source.match(/^(Rune - |Gem - |Relic - |Scroll - )/);
                        const prefix = prefixMatch ? prefixMatch[0] : '';
                        const displayName = prefix + getMonsterNameHTML(monsterName, monsterData);

                        let droprate = droprates[index] || '';
                        // Cards have a special droprate format. We identify cards by their theme color.
                        if (themeColor === 'purple') {
                            droprate = formatCardDroprate(droprate);
                        }

                        sourcesHtml += `<li class="break-words">
                            <span class="monster-link font-semibold text-${themeColor}-400 cursor-pointer" data-monster-name="${monsterName}" data-droprate="${droprate}" data-location="${locations[index] || ''}">${displayName}</span>
                        </li>`;
                    });
                    sourcesHtml += '</ul>';

                    sourcesHtml += '</div>';
                    return sourcesHtml;
                }

                function generateItemCardHTML(item) {
                    if (!item) return '';

                    // The tooltip should not contain the sources, so we pass a dummy theme color to avoid rendering them.
                    const sourceFreeItem = { ...item, Source: '' };

                    if (item.itemType === 'Equipment') {
                        return `
                            <div class="bg-gray-800/70 rounded-lg border border-gray-700/50 p-4 flex flex-col transition-all hover:border-indigo-500/50 hover:shadow-2xl hover:shadow-indigo-500/10" style="width: 420px;">
                                <div class="flex items-start mb-3">
                                    <img src="Sprites/Equipment/${item.SpriteId}.png" alt="${item.Name}" class="w-12 h-12 rounded-md bg-gray-700 mr-4 flex-shrink-0" onerror="this.onerror=null;this.src='https.placehold.co/64x64/1f2937/7c3aed?text=${item.Name.substring(0,1)}';">
                                    <div class="flex-1">
                                        <h3 class="font-bold text-lg text-white leading-tight">${item.Name}</h3>
                                        <div class="mt-1 flex items-center flex-wrap">
                                            <span class="inline-block bg-indigo-900/60 text-indigo-300 text-xs font-semibold px-2 py-0.5 rounded">${item.Type}</span>
                                            ${item['Stat Type'] ? `<span class="ml-2 inline-block bg-teal-900/60 text-teal-300 text-xs font-semibold px-2 py-0.5 rounded">${item['Stat Type']}</span>` : ''}
                                            ${item.Set ? `<span class="ml-2 inline-block bg-gray-700 text-gray-300 text-xs font-semibold px-2 py-0.5 rounded set-tooltip cursor-pointer" data-set-name="${item.Set}" data-set-bonus="${encodeURIComponent(item.SetBonuses || '')}">Set: ${item.Set}</span>` : ''}
                                        </div>
                                    </div>
                                </div>
                                <div class="flex-grow space-y-3 mb-4">
                                    ${item.PrimaryStats ? `<div><p class="text-xs text-gray-500 uppercase font-semibold">Primary Stats</p><p class="text-sm font-mono">${parseStats(item.PrimaryStats)}</p></div>` : ''}
                                    ${item.SecondaryStats ? `<div><p class="text-xs text-gray-500 uppercase font-semibold">Secondary Stats</p><p class="text-sm font-mono">${parseStats(item.SecondaryStats)}</p></div>` : ''}
                                    <div><p class="text-xs text-gray-400">Card Slots: <span class="font-semibold text-indigo-400">${item.CardSlots}</span></p></div>
                                </div>
                                <div class="mt-auto">
                                    ${renderSources(sourceFreeItem, 'indigo')}
                                </div>
                            </div>
                        `;
                    } else if (item.itemType === 'Card') {
                        return `
                            <div class="bg-gray-800/70 rounded-lg border border-gray-700/50 p-4 flex flex-col transition-all hover:border-purple-500/50 hover:shadow-2xl hover:shadow-purple-500/10" style="width: 320px;">
                                 <div class="flex items-center mb-3">
                                    <img src="Sprites/Cards/${item.Slot}.png" alt="${item.Slot} Card" class="w-14 h-14 rounded-md mr-0 flex-shrink-0" onerror="this.onerror=null;this.src='https://placehold.co/40x40/1f2937/a855f7?text=C'; this.classList.add('bg-gray-700');">
                                    <div class="flex-1 ml-4">
                                        <p class="text-xs font-bold uppercase text-purple-400">${item.Affix}</p>
                                        <h3 class="font-bold text-lg text-white leading-tight">${item.Name}</h3>
                                        <div class="mt-1">
                                            <span class="inline-block bg-purple-900/60 text-purple-300 text-xs font-semibold px-2 py-0.5 rounded">${item.Slot}</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="flex-grow mb-3">
                                    <p class="text-xs text-gray-500 uppercase font-semibold">Stats</p>
                                    <p class="text-sm font-mono">${parseStats(item.Stats)}</p>
                                </div>
                                <div class="mt-auto">
                                    ${renderSources(sourceFreeItem, 'purple')}
                                </div>
                            </div>
                        `;
                    } else if (item.itemType === 'Artifact') {
                         return `
                            <div class="relative bg-gray-800/70 rounded-lg border border-gray-700/50 p-4 transition-all hover:border-teal-500/50 hover:shadow-2xl hover:shadow-teal-500/10" style="width: 400px;">
                                <img src="Sprites/Artifacts/${item.SetName}.png" alt="${item.SetName} Set"
                                     class="absolute top-4 right-4 w-20 h-20 object-contain opacity-100"
                                     onerror="this.style.display='none'">
                                <div class="mr-20">
                                    <h3 class="font-bold text-xl text-white mb-3">${item.SetName} Set</h3>
                                    <div class="space-y-2">
                                        ${item.PerPieceBonus ? `<div><p class="text-xs text-gray-500 uppercase font-semibold">Per Piece Bonus</p><p class="text-sm font-mono">${parseStats(item.PerPieceBonus)}</p></div>` : ''}
                                        ${item.PerRefineBonus ? `<div><p class="text-xs text-gray-500 uppercase font-semibold">Per Refine Bonus</p><p class="text-sm font-mono">${parseStats(item.PerRefineBonus)}</p></div>` : ''}
                                        ${item.FullSetBonus ? `<div><p class="text-xs text-gray-500 uppercase font-semibold">Full Set Bonus</p><p class="text-sm font-mono">${parseStats(item.FullSetBonus)}</p></div>` : ''}
                                    </div>
                                </div>
                                ${renderSources(sourceFreeItem, 'teal')}
                            </div>
                        `;
                    }
                    return '';
                }

                // --- RENDERING FUNCTIONS ---

                function renderEquipmentList(data) {
                    const container = document.getElementById('equipment-list');
                    const itemsToRender = data || equipmentData;
                    container.innerHTML = `
                        <div class="grid grid-cols-[repeat(auto-fill,minmax(420px,1fr))] gap-4">
                            ${itemsToRender.map(item => `
                                <div data-item-name="${item.Name}" class="bg-gray-800/70 rounded-lg border border-gray-700/50 p-4 flex flex-col transition-all hover:border-indigo-500/50 hover:shadow-2xl hover:shadow-indigo-500/10">
                                    <div class="flex items-start mb-3">
                                        <img src="Sprites/Equipment/${item.SpriteId}.png" alt="${item.Name}" class="w-12 h-12 rounded-md bg-gray-700 mr-4 flex-shrink-0" onerror="this.onerror=null;this.src='https.placehold.co/64x64/1f2937/7c3aed?text=${item.Name.substring(0,1)}';">
                                        <div class="flex-1">
                                            <h3 class="font-bold text-lg text-white leading-tight">${item.Name}</h3>
                                            <div class="mt-1 flex items-center flex-wrap">
                                                <span class="inline-block bg-indigo-900/60 text-indigo-300 text-xs font-semibold px-2 py-0.5 rounded">${item.Type}</span>
                                                ${item['Stat Type'] ? `<span class="ml-2 inline-block bg-teal-900/60 text-teal-300 text-xs font-semibold px-2 py-0.5 rounded">${item['Stat Type']}</span>` : ''}
                                                ${item.Set ? `<span class="ml-2 inline-block bg-gray-700 text-gray-300 text-xs font-semibold px-2 py-0.5 rounded set-tooltip cursor-pointer" data-set-name="${item.Set}" data-set-bonus="${encodeURIComponent(item.SetBonuses || '')}">Set: ${item.Set}</span>` : ''}
                                            </div>
                                        </div>
                                    </div>
                                    <div class="flex-grow space-y-3 mb-4">
                                        ${item.PrimaryStats ? `<div><p class="text-xs text-gray-500 uppercase font-semibold">Primary Stats</p><p class="text-sm font-mono">${parseStats(item.PrimaryStats)}</p></div>` : ''}
                                        ${item.SecondaryStats ? `<div><p class="text-xs text-gray-500 uppercase font-semibold">Secondary Stats</p><p class="text-sm font-mono">${parseStats(item.SecondaryStats)}</p></div>` : ''}
                                        <div><p class="text-xs text-gray-400">Card Slots: <span class="font-semibold text-indigo-400">${item.CardSlots}</span></p></div>
                                    </div>
                                    <div class="mt-auto">
                                        ${renderSources(item, 'indigo')}
                                    </div>
                                </div>
                            `).join('')}
                        </div>`;
                }

                function formatCardDroprate(droprate) {
                    if (!droprate) return '';
                    const rate = parseFloat(droprate.replace('%', ''));
                    if (isNaN(rate)) return droprate;
                    // Adjust for floating point inaccuracies and remove unnecessary trailing zeros
                    return Number((rate / 100).toFixed(2)) + '%';
                }

                function renderCardsList(data) {
                    const container = document.getElementById('cards-list');
                    const itemsToRender = data || cardData;
                    container.innerHTML = `
                        <div class="grid grid-cols-[repeat(auto-fill,minmax(320px,1fr))] gap-4">
                            ${itemsToRender.map(card => `
                                <div data-item-name="${card.Name}" class="bg-gray-800/70 rounded-lg border border-gray-700/50 p-4 flex flex-col transition-all hover:border-purple-500/50 hover:shadow-2xl hover:shadow-purple-500/10">
                                     <div class="flex items-center mb-3">
                                        <img src="Sprites/Cards/${card.Slot}.png" alt="${card.Slot} Card" class="w-14 h-14 rounded-md mr-0 flex-shrink-0" onerror="this.onerror=null;this.src='https.placehold.co/40x40/1f2937/a855f7?text=C'; this.classList.add('bg-gray-700');">
                                        <div class="flex-1 ml-4">
                                            <p class="text-xs font-bold uppercase text-purple-400">${card.Affix}</p>
                                            <h3 class="font-bold text-lg text-white leading-tight">${card.Name}</h3>
                                            <div class="mt-1">
                                                <span class="inline-block bg-purple-900/60 text-purple-300 text-xs font-semibold px-2 py-0.5 rounded">${card.Slot}</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="flex-grow mb-3">
                                        <p class="text-xs text-gray-500 uppercase font-semibold">Stats</p>
                                        <p class="text-sm font-mono">${parseStats(card.Stats)}</p>
                                    </div>
                                    <div class="mt-auto">
                                        ${renderSources(card, 'purple')}
                                    </div>
                                </div>
                            `).join('')}
                        </div>`;
                }

                function renderArtifactsList(data) {
                    const container = document.getElementById('artifacts-list');
                    const itemsToRender = data || artifactData;
                    container.innerHTML = `
                        <div class="grid grid-cols-[repeat(auto-fill,minmax(400px,1fr))] gap-4">
                            ${itemsToRender.map(artifact => `
                                <div data-item-name="${artifact.SetName}" class="relative bg-gray-800/70 rounded-lg border border-gray-700/50 p-4 transition-all hover:border-teal-500/50 hover:shadow-2xl hover:shadow-teal-500/10">
                                    <img src="Sprites/Artifacts/${artifact.SetName}.png" alt="${artifact.SetName} Set"
                                         class="absolute top-4 right-4 w-20 h-20 object-contain opacity-100"
                                         onerror="this.style.display='none'">
                                    <div class="mr-20">
                                        <h3 class="font-bold text-xl text-white mb-3">${artifact.SetName} Set</h3>
                                        <div class="space-y-2">
                                            ${artifact.PerPieceBonus ? `<div><p class="text-xs text-gray-500 uppercase font-semibold">Per Piece Bonus</p><p class="text-sm font-mono">${parseStats(artifact.PerPieceBonus)}</p></div>` : ''}
                                            ${artifact.PerRefineBonus ? `<div><p class="text-xs text-gray-500 uppercase font-semibold">Per Refine Bonus</p><p class="text-sm font-mono">${parseStats(artifact.PerRefineBonus)}</p></div>` : ''}
                                            ${artifact.FullSetBonus ? `<div><p class="text-xs text-gray-500 uppercase font-semibold">Full Set Bonus</p><p class="text-sm font-mono">${parseStats(artifact.FullSetBonus)}</p></div>` : ''}
                                        </div>
                                    </div>
                                    ${renderSources(artifact, 'teal')}
                                </div>
                            `).join('')}
                        </div>`;
                }

                function renderMonstersList(data) {
                    const container = document.getElementById('monsters-list');
                    const itemsToRender = data || monsterData;
                    container.innerHTML = `
                        <div class="bg-gray-800/70 rounded-lg border border-gray-700/50 overflow-hidden">
                            <table class="w-full text-left">
                                <thead class="bg-gray-800">
                                    <tr>
                                        <th class="p-4 text-xs font-semibold uppercase text-gray-400">Name</th>
                                        <th class="p-4 text-xs font-semibold uppercase text-gray-400">Level</th>
                                        <th class="p-4 text-xs font-semibold uppercase text-gray-400">Element</th>
                                        <th class="p-4 text-xs font-semibold uppercase text-gray-400">Map</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${itemsToRender.map((monster, index) => `
                                        <tr class="border-t border-gray-700/50 ${index % 2 === 0 ? 'bg-black/10' : ''}">
                                            <td class="p-4 font-medium text-white">
                                                <span class="monster-name-link text-red-400 cursor-pointer hover:underline" data-monster-name="${monster.MonsterName}">
                                                    ${getMonsterNameHTML(monster.MonsterName, itemsToRender)}
                                                </span>
                                            </td>
                                            <td class="p-4 text-gray-300">${monster.Level}</td>
                                            <td class="p-4 text-gray-300">${colorizeElement(monster.Element)}</td>
                                            <td class="p-4 text-gray-300">${monster.Map}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>`;
                }

                // --- MONSTER MODAL LOGIC ---
                const monsterModal = document.getElementById('monster-modal');
                const monsterModalClose = document.getElementById('monster-modal-close');

                function openMonsterModal(monsterName) {
                    const monster = monsterData.find(m => m.MonsterName === monsterName);
                    if (!monster) return;

                    document.getElementById('monster-modal-name').innerHTML = getMonsterNameHTML(monster.MonsterName, monsterData);

                    const detailsContainer = document.getElementById('monster-modal-details');
                     detailsContainer.innerHTML = `
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-4 text-center">
                            <div>
                                <p class="text-sm text-gray-400 uppercase">Level</p>
                                <p class="text-lg font-semibold text-white">${monster.Level}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-400 uppercase">Element</p>
                                <p class="text-lg font-semibold">${colorizeElement(monster.Element)}</p>
                            </div>
                             <div>
                                <p class="text-sm text-gray-400 uppercase">Map</p>
                                <p class="text-lg font-semibold text-white">${monster.Map}</p>
                            </div>
                        </div>
                    `;

                    // Elemental Effectiveness Logic
                    const monsterElement = monster.Element;
                    const effectiveness = {
                        super: [],
                        notVery: [],
                        veryIneffective: []
                    };

                    for (const attackerElement in elementalChart) {
                        const defenderChart = elementalChart[attackerElement];
                        if (defenderChart[monsterElement]) {
                            const multiplier = defenderChart[monsterElement];
                            if (multiplier === 1.25) {
                                effectiveness.super.push(attackerElement);
                            } else if (multiplier === 0.75) {
                                effectiveness.notVery.push(attackerElement);
                            } else if (multiplier === 0.5) {
                                effectiveness.veryIneffective.push(attackerElement);
                            }
                        }
                    }

                    let effectivenessHtml = '<div class="mt-6 pt-4 border-t border-gray-700 text-sm">';

                    if (effectiveness.super.length > 0) {
                        effectivenessHtml += `
                            <div class="mb-2">
                                <strong class="text-green-400">Super Effective vs ${colorizeElement(monsterElement)} (125%):</strong>
                                <span class="ml-2">${effectiveness.super.map(el => colorizeElement(el)).join(', ')}</span>
                            </div>`;
                    }
                    if (effectiveness.notVery.length > 0) {
                        effectivenessHtml += `
                            <div class="mb-2">
                                <strong class="text-yellow-400">Not Very Effective (75%):</strong>
                                <span class="ml-2">${effectiveness.notVery.map(el => colorizeElement(el)).join(', ')}</span>
                            </div>`;
                    }
                    if (effectiveness.veryIneffective.length > 0) {
                        effectivenessHtml += `
                            <div class="mb-2">
                                <strong class="text-red-400">Very Ineffective (50%):</strong>
                                <span class="ml-2">${effectiveness.veryIneffective.map(el => colorizeElement(el)).join(', ')}</span>
                            </div>`;
                    }

                    effectivenessHtml += '</div>';

                    if (effectiveness.super.length > 0 || effectiveness.notVery.length > 0 || effectiveness.veryIneffective.length > 0) {
                        detailsContainer.innerHTML += effectivenessHtml;
                    }


                    // Find all loot for this monster
                    const allItems = [
                        ...equipmentData.map(item => ({ ...item, itemType: 'Equipment', themeColor: 'indigo' })),
                        ...cardData.map(item => ({ ...item, itemType: 'Card', themeColor: 'purple' })),
                        ...artifactData.map(item => ({ ...item, itemType: 'Artifact', themeColor: 'teal' }))
                    ];

                    const lootItems = [];
                    allItems.forEach(item => {
                        if (item.Source) {
                            const sources = item.Source.split('\n');
                            const droprates = item.Droprate ? item.Droprate.split('\n') : [];
                             sources.forEach((source, index) => {
                                const cleanSource = source.replace(/^(Rune - |Gem - |Relic - |Scroll - )/, '');
                                if (cleanSource === monster.MonsterName) {
                                    let droprate = droprates[index] || '';
                                    if (item.itemType === 'Card') {
                                        droprate = formatCardDroprate(droprate);
                                    }
                                    lootItems.push({ ...item, droprate });
                                }
                            });
                        }
                    });

                    const lootContainer = document.getElementById('monster-modal-loot');
                    if (lootItems.length > 0) {
                        // Group items by type
                        const groupedLoot = lootItems.reduce((acc, item) => {
                            const type = item.itemType;
                            if (!acc[type]) {
                                acc[type] = [];
                            }
                            acc[type].push(item);
                            return acc;
                        }, {});

                        let lootHtml = '';
                        const categoryOrder = ['Equipment', 'Card', 'Artifact']; // Define order

                        categoryOrder.forEach(category => {
                            if (groupedLoot[category]) {
                                // Add a divider for the category
                                const plural = category === 'Card' ? 'Cards' : (category === 'Artifact' ? 'Artifacts' : 'Equipment');
                                lootHtml += `<h4 class="text-lg font-semibold text-white mb-2 mt-4 col-span-1 md:col-span-2">${plural}</h4>`;

                                groupedLoot[category].forEach(item => {
                                    lootHtml += `
                                        <div class="bg-gray-700/50 rounded-md p-3 flex justify-between items-center text-sm loot-item"
                                             data-item-name="${item.Name || item.SetName}"
                                             data-item-type="${item.itemType}">
                                            <span class="font-semibold text-${item.themeColor}-400">${item.Name || item.SetName}</span>
                                            <span class="text-gray-400">${item.droprate || 'N/A'}</span>
                                        </div>
                                    `;
                                });
                            }
                        });
                        lootContainer.innerHTML = lootHtml;

                    } else {
                        lootContainer.innerHTML = '<p class="text-gray-500 col-span-2 text-center">No specific loot drops found for this monster.</p>';
                    }

                    monsterModal.classList.remove('hidden');
                }

                function closeMonsterModal() {
                    monsterModal.classList.add('hidden');
                }

                // --- FILTERING AND SEARCHING LOGIC ---
                function applyFiltersAndSearch() {
                    // Equipment
                    const equipmentSearchTerm = document.getElementById('equipment-search').value.toLowerCase();
                    const equipmentTypeFilter = document.getElementById('equipment-type-filter').value;
                    let filteredEquipment = equipmentData;

                    if (equipmentTypeFilter !== 'all') {
                        filteredEquipment = filteredEquipment.filter(item => item.Type === equipmentTypeFilter);
                    }
                    if (equipmentSearchTerm) {
                        filteredEquipment = filteredEquipment.filter(item => {
                            const searchIn = [item.Name, item.PrimaryStats, item.SecondaryStats, item.SetBonuses, item.Type, item.Set, item.Source, item.Location].join(' ').toLowerCase();
                            return searchIn.includes(equipmentSearchTerm);
                        });
                    }
                    renderEquipmentList(filteredEquipment);

                    // Cards
                    const cardSearchTerm = document.getElementById('cards-search').value.toLowerCase();
                    const cardSlotFilter = document.getElementById('card-slot-filter').value;
                    let filteredCards = cardData;

                    if (cardSlotFilter !== 'all') {
                        filteredCards = filteredCards.filter(item => item.Slot === cardSlotFilter);
                    }
                    if (cardSearchTerm) {
                        filteredCards = filteredCards.filter(item => {
                            const searchIn = [item.Name, item.Stats, item.Source, item.Location, item.Affix, item.Slot].join(' ').toLowerCase();
                            return searchIn.includes(cardSearchTerm);
                        });
                    }
                    renderCardsList(filteredCards);
                }

                // --- POST-DATA-LOAD INITIALIZATION ---

                // Populate filters
                const equipmentTypeFilter = document.getElementById('equipment-type-filter');
                const uniqueEquipmentTypes = [...new Set(equipmentData.map(item => item.Type))].sort();
                uniqueEquipmentTypes.forEach(type => {
                    const option = document.createElement('option');
                    option.value = type;
                    option.textContent = type;
                    equipmentTypeFilter.appendChild(option);
                });

                const cardSlotFilter = document.getElementById('card-slot-filter');
                const uniqueCardSlots = [...new Set(cardData.map(item => item.Slot))].sort();
                uniqueCardSlots.forEach(slot => {
                    const option = document.createElement('option');
                    option.value = slot;
                    option.textContent = slot;
                    cardSlotFilter.appendChild(option);
                });

                // Initial render
                renderEquipmentList();
                renderCardsList();
                renderArtifactsList();
                renderMonstersList();

                const contentSections = document.querySelectorAll('.content-section');
                const tooltip = document.getElementById('tooltip');

                // --- HASH-BASED NAVIGATION ---
                let pendingSearch = null; // Variable to hold search info during navigation
                let pendingHighlight = null; // Variable to hold highlight info during navigation

                function showSectionBasedOnHash() {
                    console.log('showSectionBasedOnHash triggered. pendingHighlight is:', pendingHighlight);
                    let targetId = window.location.hash.substring(1);
                    if (!targetId || !document.getElementById(targetId)) {
                        targetId = 'equipment';
                        // Update hash to reflect default view
                        if (window.location.pathname.endsWith('database.html') && !window.location.hash) {
                            history.replaceState(null, '', '#equipment');
                        }
                    }

                    // Toggle content visibility
                    contentSections.forEach(section => {
                        section.classList.toggle('hidden', section.id !== targetId);
                    });

                    // If there's a pending highlight after a navigation, execute it now.
                    if (pendingHighlight && pendingHighlight.itemName) {
                        // Need to escape special characters for querySelector, especially quotes.
                        const itemName = pendingHighlight.itemName.replace(/"/g, '\\"');
                        const sectionElement = document.getElementById(targetId);

                        if (!sectionElement) {
                            pendingHighlight = null;
                            return;
                        }
                        const targetElement = sectionElement.querySelector(`[data-item-name="${itemName}"]`);

                        if (targetElement) {
                            targetElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            targetElement.classList.add('highlight-effect');

                            setTimeout(() => {
                                targetElement.classList.remove('highlight-effect');
                            }, 2000); // Highlight duration
                        }
                        pendingHighlight = null; // Reset after use
                    }
                }

                showSectionBasedOnHash();
                window.addEventListener('hashchange', showSectionBasedOnHash);


                // Filter and Search event listeners
                document.getElementById('equipment-search').addEventListener('input', applyFiltersAndSearch);
                document.getElementById('equipment-type-filter').addEventListener('change', applyFiltersAndSearch);
                document.getElementById('cards-search').addEventListener('input', applyFiltersAndSearch);
                document.getElementById('card-slot-filter').addEventListener('change', applyFiltersAndSearch);

                document.getElementById('artifacts-search').addEventListener('keyup', (e) => {
                    const searchTerm = e.target.value.toLowerCase();
                    const filteredData = artifactData.filter(item => {
                        const searchIn = [
                            item.SetName, item.PerPieceBonus, item.PerRefineBonus,
                            item.FullSetBonus, item.Source, item.Location
                        ].join(' ').toLowerCase();
                        return searchIn.includes(searchTerm);
                    });
                    renderArtifactsList(filteredData);
                });

                document.getElementById('monsters-search').addEventListener('keyup', (e) => {
                    const searchTerm = e.target.value.toLowerCase();
                    const filteredData = monsterData.filter(item => {
                        const searchIn = [
                            item.MonsterName, item.Element, item.Map
                        ].join(' ').toLowerCase();
                        return searchIn.includes(searchTerm);
                    });
                    renderMonstersList(filteredData);
                });

                // Logic to keep search bar expanded if it has content
                const searchInputs = document.querySelectorAll('.search-input');
                searchInputs.forEach(input => {
                    // Function to toggle the 'expanded' class
                    const checkSearchContent = () => {
                        if (input.value) {
                            input.classList.add('expanded');
                        } else {
                            input.classList.remove('expanded');
                        }
                    };

                    // Check on input event
                    input.addEventListener('input', checkSearchContent);

                    // Also check on page load in case of autofill
                    checkSearchContent();
                });


                // Monster Modal event listeners
                monsterModalClose.addEventListener('click', closeMonsterModal);
                monsterModal.addEventListener('click', (e) => {
                    if (e.target === monsterModal) {
                        closeMonsterModal();
                    }
                });
                document.getElementById('monsters-list').addEventListener('click', (e) => {
                    const target = e.target.closest('.monster-name-link');
                    if (target) {
                        const monsterName = target.getAttribute('data-monster-name');
                        openMonsterModal(monsterName);
                    }
                });

                // Click handler for monster links in sources
                document.body.addEventListener('click', e => {
                    const monsterLink = e.target.closest('.monster-link');
                    if (monsterLink) {
                        const monsterName = monsterLink.dataset.monsterName;
                        if (monsterName) {
                            openMonsterModal(monsterName);
                        }
                    }
                });

                // Click handler for loot items in the monster modal
                document.body.addEventListener('click', e => {
                    const lootItem = e.target.closest('.loot-item');
                    if (lootItem) {
                        const itemName = lootItem.dataset.itemName;
                        const itemType = lootItem.dataset.itemType;

                        if (itemName && itemType) {
                            const sectionMap = {
                                'Equipment': { hash: 'equipment' },
                                'Card': { hash: 'cards' },
                                'Artifact': { hash: 'artifacts' }
                            };

                            const section = sectionMap[itemType];
                            if (section) {
                                closeMonsterModal();

                                // Set up the pending highlight object
                                pendingHighlight = {
                                    itemName: itemName
                                };
                                console.log('pendingHighlight set:', pendingHighlight);

                                const targetHash = `#${section.hash}`;
                                // If we are already on the correct section, the hash won't change,
                                // so the 'hashchange' event won't fire. We need to trigger the
                                // highlight logic manually in this case.
                                if (window.location.hash === targetHash) {
                                    showSectionBasedOnHash();
                                } else {
                                    // Otherwise, changing the hash will trigger the event listener.
                                    window.location.hash = section.hash;
                                }
                            }
                        }
                    }
                });

                // Global Tooltip Logic
                document.body.addEventListener('mouseover', (e) => {
                    const target = e.target.closest('.monster-link, .set-tooltip, .boss-icon, .loot-item');
                    if (!target) return;

                    let content = '';
                    let displayTooltip = false;

                    if (target.classList.contains('monster-link')) {
                        const monsterName = target.getAttribute('data-monster-name');
                        const droprate = target.getAttribute('data-droprate');
                        const location = target.getAttribute('data-location');
                        const monsterInfo = monsterData.find(m => m.MonsterName === monsterName);

                        content = `<h4 class="font-bold text-white text-base mb-2">${getMonsterNameHTML(monsterName, monsterData)}</h4>`;
                        let detailsFound = false;

                        if (monsterInfo) {
                            content += `<p><strong>Level:</strong> ${monsterInfo.Level}</p>
                                      <p><strong>Element:</strong> ${colorizeElement(monsterInfo.Element)}</p>`;
                            detailsFound = true;
                        }
                        if (droprate && droprate !== 'null') {
                            content += `<p><strong>Droprate:</strong> ${droprate}</p>`;
                            detailsFound = true;
                        }
                        const mapLocation = location || (monsterInfo ? monsterInfo.Map : null);
                        if (mapLocation && mapLocation !== 'null') {
                            content += `<p><strong>Map:</strong> ${mapLocation}</p>`;
                            detailsFound = true;
                        }
                        if (!detailsFound) {
                            content += `<p class="text-gray-500">Details not found.</p>`;
                        }
                        displayTooltip = true;

                    } else if (target.classList.contains('set-tooltip')) {
                        const setName = target.getAttribute('data-set-name');
                        const setBonus = decodeURIComponent(target.getAttribute('data-set-bonus'));
                        if (setBonus) {
                            content = `<h4 class="font-bold text-white text-base mb-2">${setName} Set Bonus</h4>`;
                            content += `<div class="font-mono text-sm">${parseStats(setBonus)}</div>`;
                            displayTooltip = true;
                        }
                    } else if (target.classList.contains('boss-icon')) {
                        const tooltipText = target.getAttribute('data-tooltip-text');
                        if (tooltipText) {
                            content = `<p>${tooltipText}</p>`;
                            displayTooltip = true;
                        }
                    } else if (target.classList.contains('loot-item')) {
                        const itemName = target.getAttribute('data-item-name');
                        const itemType = target.getAttribute('data-item-type');
                        let itemData = null;

                        if (itemType === 'Equipment') {
                            itemData = equipmentData.find(i => i.Name === itemName);
                        } else if (itemType === 'Card') {
                            itemData = cardData.find(i => i.Name === itemName);
                        } else if (itemType === 'Artifact') {
                            itemData = artifactData.find(i => i.SetName === itemName);
                        }

                        if (itemData) {
                            // Add itemType to the found data object as it's used by generateItemCardHTML
                            itemData.itemType = itemType;
                            content = generateItemCardHTML(itemData);
                            // The card itself has padding, so we remove it from the tooltip container
                            tooltip.style.padding = '0';
                            displayTooltip = true;
                        }
                    }

                    if (displayTooltip) {
                        tooltip.innerHTML = content;
                        tooltip.style.display = 'block';
                    } else {
                        // Reset padding if no tooltip is shown or for other tooltips
                        tooltip.style.padding = '10px';
                    }
                });

                document.body.addEventListener('mouseout', (e) => {
                    const target = e.target.closest('.monster-link, .set-tooltip, .boss-icon, .loot-item');
                     if (target) {
                        tooltip.style.display = 'none';
                    }
                });

                document.addEventListener('mousemove', (e) => {
                    if (tooltip.style.display === 'block') {
                        tooltip.style.left = `${e.pageX + 15}px`;
                        tooltip.style.top = `${e.pageY + 15}px`;
                    }
                });

            } catch (error) {
                console.error("Failed to load game data:", error);
                document.getElementById('content-container').innerHTML = `<p class="text-red-400">Error loading data. Please ensure all data scripts are loaded correctly.</p>`;
            }
        });
    </script>
</body>
</html>